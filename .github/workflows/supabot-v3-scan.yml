name: Supabot V3 Scanner (Optimized)

on:
  schedule:
    # Run once daily at 2:00 PM EST = 7:00 PM UTC
    - cron: '0 19 * * 1-5'
  
  workflow_dispatch:  # Manual trigger

jobs:
  scan-v3:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # V3 is faster
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: üì¶ Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: ‚öôÔ∏è Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install gspread oauth2client
      
      - name: üîë Create service account file
        run: |
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT }}' > service_account.json
      
      - name: üöÄ Run Supabot V3 (Optimized)
        env:
          # API Keys (V3 only needs these)
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT }}
          TWITTERAPI_IO_KEY: ${{ secrets.TWITTERAPI_IO_KEY }}
          DISCORD_WEBHOOK_V3: ${{ secrets.DISCORD_WEBHOOK_V3 }}
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}          # NEW
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}    # NEW
        run: |
          echo "üöÄ Starting V3 optimized scan at $(date)"
          python3 supabot_v3.py
          echo "‚úÖ V3 scan completed at $(date)"
        
        continue-on-error: true
      
      - name: üìä Auto-fill Google Sheet
        if: success()
        run: |
          echo "üìù Filling Google Sheet..."
          python3 auto_sheet.py
          echo "‚úÖ Sheet updated at $(date)"
        continue-on-error: true
      
      - name: üìä Upload V3 results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: v3-scan-results-${{ github.run_number }}
          path: outputs/supabot_v3*.csv
          retention-days: 30
          if-no-files-found: warn
      
      - name: üìã Display V3 summary
        if: always()
        run: |
          echo "=================================="
          echo "V3 Scan Summary (Optimized)"
          echo "=================================="
          if [ -d "outputs" ]; then
            echo "Generated files:"
            ls -lh outputs/supabot_v3*.csv 2>/dev/null || echo "No V3 CSV files found"
          else
            echo "‚ö†Ô∏è  No outputs directory"
          fi
      
      - name: üö® Notify on failure
        if: failure()
        run: |
          echo "‚ùå V3 Workflow failed!"
          echo "Check logs above for errors"